<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>S3A</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@100..900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Outfit', sans-serif;
            margin: 20px;
            background-color: #b7fcd6;
        }

        .sidebar {
            font-family: 'Outfit', sans-serif;
            height: 100vh;
            width: 200px;
            position: fixed;
            top: 0;
            left: 0;
            background-color: #31b66f;
            padding-top: 20px;
        }

        .sidebar h1 {
            font-family: 'Outfit', sans-serif;
            color: white;
            text-align: center;
            margin-bottom: 20px;
        }

        .sidebar a {
            display: block;
            color: white;
            padding: 12px;
            text-decoration: none;
        }

        .sidebar a:hover {
            background-color: #49d88c;
        }

        .sidebar a.selecionado {
            background-color: #49d88c;
        }

        .wrapper {
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;

        }

        .title {
            font-family: 'Outfit', sans-serif;
            margin-bottom: 20px;
            font-size: 50px;
            color: #157e46;
            text-align: center;
        }

        .form-box {
            background-color: #e1feee;
            padding: 20px;
            border-radius: 8px 8px 0 0;
            width: 600px;
            height: auto;
        }

        input[type="number"] {
            width: 100%;
            padding: 8px;
            margin: 8px 0;
            box-sizing: border-box;
            border: 2px solid #ccc;
            border-radius: 4px;
        }

        label {
            font-family: 'Outfit', sans-serif;
            font-size: 18px;
            color: #0d4e2b;
            font-weight: 500;
        }

        input[type="submit"] {
            background-color: #31b66f;
            color: white;
            width: 100%;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s ease;
        }

        input[type="submit"]:hover {
            background-color: #49d88c;
        }

        #resultado {
            justify-self: center;
            border-radius: 0 0 8px 8px;
            background-color: #e1feee;
            transition: background-color 0.3s ease;
        }
    </style>
</head>

<body>
    <div class="sidebar">
        <h1>S3A</h1>
        <a href="#home">Home</a>
        <a href="#funcionarios">Funcionários</a>
        <a href="#desconto-umidade-calculo" class="selecionado">Cálculo de desconto de umidade</a>
        <a href="#estoque">Estoque</a>
        <a href="#caminhoes">Caminhões</a>
        <a href="#plan">Planejamento de safra</a>
        <a href="#visao">Visão Geral</a>
        <a href="#contato">Contato</a>
    </div>
    <div class="wrapper">
        <h2 class="title">Cálculo de desconto <br> de umidade</h2>
        <div class="form-box" id="form-romaneio">
            <form>
                <!-- 
                dados necessários: 
                 - peso bruto
                 - tara do caminhão
                 - peso líquido(peso bruto - tara)
                 - umidade inicial da amostra
                 - desconto de umidade(peso líquido * (umidade inicial - 14%) * 0.04)
                    - peso líquido final (peso líquido - desconto de umidade)
                -->
                <label for="peso-bruto">Peso Bruto (kg):</label><br>
                <input type="number" id="peso-bruto" name="peso-bruto" required><br><br>
                <label for="tara">Tara do Caminhão (kg):</label><br>
                <input type="number" id="tara" name="tara" required><br><br>
                <label for="umidade-inicial">Umidade Inicial (%):</label><br>
                <input type="number" id="umidade-inicial" name="umidade-inicial" step="0.01" required><br><br>
                <input type="submit" value="Calcular">
            </form>
        </div>
        <div id="resultado" class="form-box"></div>
    </div>

    <script>
        (() => {
            const API = "http://localhost:6969/api/romaneio/calcular";

            function toNumber(v) {
                if (typeof v !== "string") return Number(v);
                let s = v.trim();
                if (s === "") return NaN;

                const hasComma = s.includes(",");
                const hasDot = s.includes(".");

                if (hasComma && !hasDot) {
                    return Number(s.replace(/\./g, "").replace(",", "."));
                }
                if (hasDot && !hasComma) {
                    return Number(s.replace(/,/g, ""));
                }
                if (hasDot && hasComma) {
                    const lastComma = s.lastIndexOf(",");
                    const lastDot = s.lastIndexOf(".");
                    if (lastComma > lastDot) {
                        return Number(s.replace(/\./g, "").replace(",", "."));
                    } else {
                        return Number(s.replace(/,/g, ""));
                    }
                }
                return Number(s);
            }


            function fmtKg(n) { return `${Number(n).toFixed(2)} kg`; }
            function fmtPct(n) { return `${Number(n).toFixed(2)} %`; }

            const form = document.getElementById("form-romaneio");
            const elPesoBruto = document.getElementById("peso-bruto");
            const elTara = document.getElementById("tara");
            const elUmidade = document.getElementById("umidade-inicial");
            const boxResultado = document.getElementById("resultado");

            if (!form) {
                console.error("Formulário não encontrado.");
                return;
            }

            form.addEventListener("submit", async (e) => {
                e.preventDefault();

                const pesoBruto = toNumber(elPesoBruto.value);
                const tara = toNumber(elTara.value);
                const umidade = toNumber(elUmidade.value);

                // validaciones sapequinhas
                if (isNaN(pesoBruto) || isNaN(tara) || isNaN(umidade)) {
                    return renderErro("Preencha todos os campos com números válidos (pode usar vírgula).");
                }
                if (pesoBruto <= 0 || tara < 0) {
                    return renderErro("Peso bruto deve ser > 0 e a tara não pode ser negativa.");
                }
                if (tara >= pesoBruto) {
                    return renderErro("A tara precisa ser menor que o peso bruto.");
                }
                if (umidade < 0 || umidade > 100) {
                    return renderErro("Umidade deve estar entre 0 e 100%.");
                }

                try {
                    const qs = new URLSearchParams({
                        pesoBruto: String(pesoBruto),
                        tara: String(tara),
                        umidade: String(umidade)
                    });

                    const url = `${API}?${qs.toString()}`;
                    const resp = await fetch(url, { method: "GET" });

                    if (!resp.ok) {
                        const txt = await resp.text();
                        throw new Error(`Erro HTTP ${resp.status}: ${txt}`);
                    }

                    const data = await resp.json();
                    renderSucesso(data);
                } catch (err) {
                    renderErro(`Falha ao calcular: ${err.message}`);
                }
            });

            function renderSucesso(r) {
                boxResultado.style.display = "block";
                boxResultado.innerHTML = `
      <h3 style="margin-top:0;color:#157e46;font-family:'Outfit',sans-serif;">Resultado do Cálculo</h3>
      <div style="font-family:'Outfit',sans-serif;color:#0d4e2b;">
        <p><strong>Peso Bruto:</strong> ${fmtKg(r.pesoBruto)}</p>
        <p><strong>Tara:</strong> ${fmtKg(r.tara)}</p>
        <p><strong>Peso Líquido:</strong> ${fmtKg(r.pesoLiquido)}</p>
        <p><strong>Umidade informada:</strong> ${fmtPct(r.umidadeInformada)}</p>
        <p><strong>Percentual de desconto aplicado:</strong> ${fmtPct(r.percentualDescontoAplicado)}</p>
        <p><strong>Desconto em kg:</strong> ${fmtKg(r.descontoEmKg)}</p>
        <hr>
        <p><strong>Peso Final:</strong> ${fmtKg(r.pesoFinal)}</p>
      </div>
    `;
            }

            function renderErro(msg) {
                boxResultado.style.display = "block";
                boxResultado.innerHTML = `
      <h3 style="margin-top:0;color:#b91c1c;font-family:'Outfit',sans-serif;">Erro</h3>
      <p style="color:#7f1d1d;font-family:'Outfit',sans-serif;">${msg}</p>
    `;
            }
        })();
    </script>

</body>

</html>